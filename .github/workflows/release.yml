name: åˆ›å»º Release

on:
  push:
    tags:
      - 'v*'  # å½“æŽ¨é€ä»¥ v å¼€å¤´çš„ tag æ—¶è§¦å‘

permissions:
  contents: write

jobs:
  create-release:
    runs-on: ubuntu-latest
    steps:
      # æ£€å‡ºä»£ç 
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # èŽ·å–å®Œæ•´çš„ git åŽ†å²,ç”¨äºŽç”Ÿæˆæ›´æ–°æ—¥å¿—

      # èŽ·å–ç‰ˆæœ¬å·
      - name: èŽ·å–ç‰ˆæœ¬å·
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "å½“å‰ç‰ˆæœ¬: ${VERSION}"

      # ç”Ÿæˆæ›´æ–°æ—¥å¿—
      - name: ç”Ÿæˆæ›´æ–°æ—¥å¿—
        id: changelog
        run: |
          # èŽ·å–ä¸Šä¸€ä¸ª tag
          PREVIOUS_TAG=$(git tag --sort=-version:refname | sed -n '2p')

          if [ -z "$PREVIOUS_TAG" ]; then
            echo "è¿™æ˜¯ç¬¬ä¸€ä¸ª release"
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" --no-merges)
          else
            echo "å¯¹æ¯” ${PREVIOUS_TAG} å’Œå½“å‰ç‰ˆæœ¬çš„å˜æ›´"
            CHANGELOG=$(git log ${PREVIOUS_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
          fi

          # ä¿å­˜åˆ°æ–‡ä»¶
          echo "${CHANGELOG}" > changelog.txt
          cat changelog.txt

      # åˆ›å»º GitHub Release
      - name: åˆ›å»º Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ steps.get_version.outputs.version }}
          body_path: changelog.txt
          draft: false
          prerelease: false
          generate_release_notes: true  # è‡ªåŠ¨ç”Ÿæˆ release notes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ç”Ÿæˆæ€»ç»“
      - name: ç”Ÿæˆæž„å»ºæ€»ç»“
        run: |
          echo "## Release åˆ›å»ºæˆåŠŸ ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ç‰ˆæœ¬:** ${{ steps.get_version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Release é“¾æŽ¥:** https://github.com/${{ github.repository }}/releases/tag/${{ steps.get_version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
